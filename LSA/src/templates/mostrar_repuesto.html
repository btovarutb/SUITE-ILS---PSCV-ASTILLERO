{% extends '/base.html' %}

{% block title %}Cotecmar || Equipo - Repuestos{% endblock %}

{% block custom %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/FMEA.css') }}">
{% endblock %}

{% block body %}
<div class="container" id="reporte" >
  <div class="row toolBar">
    <div class="col-8 m-0 pt-3" style="align-content: center;">
        <h3 class="titulo">Modulo de repuestos</h3>
        <h5 style="color: #013882; padding-left: 10px; "> Para {{ nombre_equipo }} </h5>
    </div>
    <div class="col-4 pt-3" style="align-items: start; justify-content: end; display: flex; padding-right: 1.5rem;">
        <div class="buttons" style="display: flex; gap: 10px;">
            <a href="{{ url_for('registro_repuesto',id_equipo_info=id_equipo_info) }}" 
               class="btn btn-primary">Agregar repuesto</a>
            <a href="{% if from_url %}{{ from_url }}{% if '?' in from_url %}&from=modulo_repuestos{% else %}?from=modulo_repuestos{% endif %}{% else %}{{ url_for('mostrar_general_page', id_equipo_info=id_equipo_info) }}{% endif %}">
                Cerrar módulo </a>
        </div>                
    </div>
  </div>
  <div id="fade-container"></div>
  <div class="p-4 pt-0">
    <table class="table table-bordered">
      <thead>
          <tr>
            <th scope="col">Nombre del repuesto</th>
            <th scope="col">Valor</th>
            <th scope="col">Dibujo de sección transversal</th>
            <th scope="col">MTBF</th>
            <th scope="col">Código OTAN</th>
            <th scope="col">Notas</th>
            <th scope="col" colspan="2">Acciones</th>
          </tr>
      </thead>
      <tbody>
          {% for repuesto in repuestos %}
          <tr>
            <td>{{ repuesto.nombre_repuesto }}</td>
            <td>{{ repuesto.valor }}</td>
            <td>
              {% if repuesto.dibujo_transversal %}
                  {% set imagen_base64 = repuesto.dibujo_transversal|b64encode %}
                  {% set mime_prefix = imagen_base64[:5] %}
                  {% if mime_prefix in ['iVBOR', '/9j/4'] %}
                    <button type="button" class="btn btn-link ver-imagen" data-bs-toggle="modal" data-bs-target="#modalImagen" data-imagen="data:image/png;base64,{{ imagen_base64 }}">
                      Ver imagen
                    </button>
                  {% else %}
                    <span class="text-muted">Imagen no disponible</span>
                  {% endif %}
              {% else %}
                <span class="text-muted">Sin imagen</span>
              {% endif %}
            </td>
            <td>{{ repuesto.mtbf }}</td>
            <td>{{ repuesto.codigo_otan }}</td>
            <td>{{ repuesto.notas }}</td>
            <td>
              <button class="btn boton btn-editar " data-id="{{ repuesto.id }}" data-id-equipo-info="{{id_equipo_info}}"><i class="bi bi-pen pen" ></i></button>
            </td>
            <td>
              <button class="btn btn-danger btn-eliminar" data-id="{{ repuesto.id }}" data-id-equipo-info="{{id_equipo_info}}"><i class="bi bi-trash-fill"></i></button>
            </td>
          </tr>
          {% endfor %}
      </tbody>
      <script src="{{ url_for('static', filename='js/mostrar_repuesto.js') }}"></script>
    </table>
  </div>
</div>

  <!-- Modal de Imagen (reutiliza el mismo id usado en otras vistas) -->
  <div class="modal fade" id="modalImagen" tabindex="-1" aria-labelledby="modalImagenLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body text-center">
          <img id="imagenModal" class="img-fluid rounded" style="max-width: 90%; max-height: 80vh;" alt="Imagen no disponible">
        </div>
      </div>
    </div>
  </div>
{% endblock %}
