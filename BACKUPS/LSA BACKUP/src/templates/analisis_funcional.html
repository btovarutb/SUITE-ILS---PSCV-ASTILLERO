<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotecmar || Equipo - Análisis funcional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/FMEA.css') }}">
    <style>
        .componentes {
            margin-top: 20px;
        }

        .selected {
            background-color: #e8f4ff;
        }
    </style>
</head>
<body>
    <main>
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
            <h2 class="section-title text-center"> Análisis Funcional</h2>
            <button data-url="{{ url_for('mostrar_analisis_funcional_ext', id_equipo_info=id_equipo_info) }}"
                data-section="section12" 
                class="btn btn-primary no-print" 
                style="padding: 8px 15px; border-radius: 10px;">
              <i class="bi bi-pen" style="color: whitesmoke; font-size: 14px;"></i>
            </button>
        </div> 
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th scope="col">Sistema</th>
                    <th scope="col">Subsistema</th>
                    <th scope="col">Verbo</th>
                    <th scope="col">Acción</th>
                    <th scope="col">Estándar de desempeño</th>
                </tr>
            </thead>
            <tbody>
        
            {% for analisis in analisis_funcionales %}
                <tr class="analisis-row" onclick="toggleComponentes({{ analisis.id }})">
                    <td>{{ sistema.nombre if sistema else 'No hay sistema seleccionado' }}</td>
                    <td>{{ analisis.subsistema_nombre }}</td>
                    <td>{{ analisis.verbo }}</td>
                    <td>{{ analisis.accion }}</td>
                    <td>{{ analisis.estandar_desempeño }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        
        {% for analisis in analisis_funcionales %}
            <!-- Tabla de componentes para cada análisis funcional, inicialmente oculta -->
            <table id="componentes-{{ analisis.id }}" class="table componentes table-bordered" style="display: none;">
                <thead>
                    <tr>
                        <th colspan="3">{{ analisis.subsistema_nombre | title }}</th>
                    </tr>
                    <tr>
                        <th scope="col">Nombre</th>
                        <th scope="col">Verbo</th>
                        <th scope="col">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for componente in componentes %}
                        {% if componente.id_analisis_funcional == analisis.id %}
                        <tr>
                            <td>{{ componente.nombre }}</td>
                            <td>{{ componente.verbo }}</td>
                            <td>{{ componente.accion }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% endfor %}
    </main>

    <!-- JavaScript para mostrar/ocultar componentes con scroll -->
    <script>
        function toggleComponentes(idAnalisis) {
            // Seleccionar la tabla de componentes correspondiente
            var tablaComponentes = document.getElementById('componentes-' + idAnalisis);

            // Mostrar/ocultar la tabla de componentes
            if (tablaComponentes.style.display === 'none') {
                // Ocultar otras tablas de componentes
                document.querySelectorAll('.componentes').forEach(function(tabla) {
                    tabla.style.display = 'none';
                });

                // Resaltar fila seleccionada
                document.querySelectorAll('.analisis-row').forEach(function(row) {
                    row.classList.remove('selected');
                });

                // Mostrar la tabla y resaltar la fila
                tablaComponentes.style.display = 'table';
                var selectedRow = document.querySelector(`tr[onclick="toggleComponentes(${idAnalisis})"]`);
                if (selectedRow) selectedRow.classList.add('selected');

                // Desplazar el scroll hacia la tabla de componentes
                tablaComponentes.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Ocultar la tabla y remover el resaltado de la fila
                tablaComponentes.style.display = 'none';
                var selectedRow = document.querySelector(`tr[onclick="toggleComponentes(${idAnalisis})"]`);
                if (selectedRow) selectedRow.classList.remove('selected');
            }
        }
    </script>
</body>
</html>
