{% extends './base.html' %}


{% block title %}LSA{% endblock %}
{% block body %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fua_stress.css') }}">

    <script src="{{ url_for('static', filename='js/fua_stress.js') }}"></script>
    <script src="{{ url_for('static', filename='js/global.js') }}"></script>

    <div class="main-container" id="viewIdentifier" data-view="index">
        <div class="row p-4">
            <div class="col-md-4">
                <div id="navigation-info">
                    <button class="volverBtn" onclick="window.history.back()">
                        <i class="bi bi-chevron-left"></i>
                    </button>                    
                    <p>EQUIPOS SISTEMA {{ nombre }}</p>
                </div>
    
                <div class="list-group">
                    <!-- Campo de búsqueda -->
                    <input type="text" class=" form-control mb-2" placeholder="Buscar equipo" id="buscar-equipo">
                
                    <!-- Contenedor para los equipos -->
                    <div class="list-group-equipos">
                        {% if equipos %}
                            {% for equipo in equipos %}
                                <button 
                                    class="list-group-item list-group-item-action" 
                                    data-id="{{ equipo.id }}" 
                                    data-fua-fr='{{ equipo.fua_fr | tojson | replace("\"", "&quot;") | safe }}' 
                                    onclick="cargarEquipo('{{ equipo.id }}')">
                                    {{ equipo.nombre_equipo }}
                                </button>
                            {% endfor %}                
                        {% else %}
                            <div id="mensaje-predeterminado" class="text-center text-muted p-4">
                                No se encontraron equipos asignados a este sistema y buque.
                            </div>
                        {% endif %}
                    </div>
                </div>     
            </div>
            <div class="col-8">
                <div id="detalle-equipo">
                    <div id="mensaje-predeterminado" class="text-center text-muted p-4">
                        Seleccione un equipo o cree uno nuevo.
                    </div>
                    <div class="card-body pt-1">
                        <div class="row" id="NavTools">
                            <!-- Botones de navegación -->
                            <div class="buttons pb-1">
                                <button class="tab-button btn active" data-target="section1">Factor de utilización anual (FUA)</button>
                                <button class="tab-button btn" data-target="section2">Factor de rendimiento (FR)</button>
                            </div>
    
                            <div id="EditionButton" style="width: 50px; display: flex; padding: 0; gap: 10px; justify-content: flex-end;">
                                <button id="btn-editar" class="btn" onclick="">
                                    <i id="icono-editar" class="bi bi-pencil"></i>
                                </button>
                            </div>
                        </div>
                        <div id="fade-container"></div>

                        <div class="content" id="content">
                            <div id="section1" class="zone section active">
                                <!-- Filas estáticas -->
                                <p class="subtitulo mb-1">Puerto base</p>
                                <!-- Campos estáticos -->
                                {% for campo in campos_estaticos %}
                                <div class="row mb-2">
                                    <div class="col-md-5">
                                        <label for="{{ campo.id }}" class="form-label">{{ campo.label }}</label>
                                    </div>
                                    <div class="col-md-2 withUnid">
                                        <input type="number" class="form-control" id="{{ campo.id }}" name="{{ campo.id }}" readonly placeholder="0.00" step="0.01" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="col-md-5">
                                        <textarea class="form-control" id="descripcion-{{ campo.id }}" name="descripcion-{{ campo.id }}" readonly rows="2" placeholder="Descripción"></textarea>
                                    </div>
                                </div>
                                {% endfor %}

                            
                                <p class="subtitulo pt-4 mb-1">Puerto Extranjero</p>
                                <!-- Filas dinámicas basadas en misiones -->
                                {% for mision in misiones %}
                                <div class="row mb-2">
                                    <div class="col-md-5">
                                        <label for="{{ mision.normalized_id }}" class="form-label">{{ mision.mision }}</label>
                                    </div>
                                    <div class="col-md-2 withUnid">
                                        <input type="number" class="form-control" id="{{ mision.normalized_id }}" 
                                            name="{{ mision.normalized_id }}" readonly 
                                            placeholder="0,00" step="0.01" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="col-md-5">
                                        <textarea class="form-control" id="descripcion-{{ mision.normalized_id }}" 
                                                name="descripcion-{{ mision.normalized_id }}" readonly 
                                                rows="2" placeholder="Descripción"></textarea>
                                    </div>
                                </div>
                                {% endfor %}

                                <div class="row mt-3 mb-3">
                                    <div class="col-md-12">
                                        <p class="subtitulo mb-1">Resultados FUA</p>
                                        <div class="row">
                                            <div class="col-6 d-flex justify-content-around align-items-center">
                                                <p class="m-0">AOR:</p>
                                                <div class="withUnid" style="width: 50%">
                                                    <input type="text" class="form-control" style="width: 50%; text-align: end" id="resultado-fua" readonly placeholder="0.00">
                                                    <span class="input-group-text">horas</span>
                                                </div>
                                            </div>
                                            <div class="col-6 d-flex justify-content-around align-items-center">
                                                <p class="m-0">AOR Porcentual:</p>
                                                <div class="withUnid" style="width: 50%">
                                                    <input type="text" class="form-control" id="resultado-fua-porcentaje" style="text-align: end" readonly placeholder="0.00">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="section2" class="zone section">
                                <!-- Filas estáticas -->
                                {% for campo in campos_estaticos %}
                                <div class="row mb-2">
                                    <div class="col-md-5">
                                        <label for="fr-{{ campo.normalized_id }}" class="form-label">{{ campo.label }}</label>
                                    </div>
                                    <div class="col-md-2 withUnid">
                                        <input type="number" class="form-control" id="fr-{{ campo.normalized_id }}" 
                                               name="fr-{{ campo.normalized_id }}" readonly 
                                               placeholder="0,00" step="0.01" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="col-md-5">
                                        <textarea class="form-control" id="descripcion-fr-{{ campo.normalized_id }}" 
                                                  name="descripcion-fr-{{ campo.normalized_id }}" readonly 
                                                  rows="2" placeholder="Descripción"></textarea>
                                    </div>
                                </div>
                                {% endfor %}
                            
                                <!-- Filas dinámicas basadas en misiones -->
                                {% for mision in misiones %}
                                <div class="row mb-2">
                                    <div class="col-md-5">
                                        <label for="fr-{{ mision.normalized_id }}" class="form-label">{{ mision.mision }}</label>
                                    </div>
                                    <div class="col-md-2 withUnid">
                                        <input type="number" class="form-control" id="fr-{{ mision.normalized_id }}" 
                                            name="fr-{{ mision.normalized_id }}" readonly 
                                            placeholder="0,00" step="0.01" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="col-md-5">
                                        <textarea class="form-control" id="descripcion-fr-{{ mision.normalized_id }}" 
                                                name="descripcion-fr-{{ mision.normalized_id }}" readonly 
                                                rows="2" placeholder="Descripción"></textarea>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="d-none flex-row-reverse espacioGuardado"style="padding: 1.2rem;">
                                <button id="btn-guardar" type="button" class="btn"
                                    style="background-color: #003366; color: white;"
                                    onclick="guardarFuaFr()">Guardar</button>
                            </div>                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
function configurarInputsYCalcular(fuaFrData) {
    const datosPuertoBase = JSON.parse('{{ datosPuertoBase | tojson }}');
    const puertoBase = datosPuertoBase; // Tomamos el primer elemento del array

    console.log(datosPuertoBase)
    // Definir valores estáticos
    const valoresEstaticos = {
        disponible_para_misiones: parseFloat(puertoBase.disponible_misiones_1) || 0,
        disponibilidad_de_mantenimiento: parseFloat(puertoBase.mant_basico_1) || 0,
        revision_periodica_roh: parseFloat(puertoBase.roh_1) || 0
    };

    // Función para calcular el resultado
    function calcularFua() {
        let sumaEstaticos = 0;
        let sumaDinamicos = 0;

        console.group("Cálculo de FUA");

        // Calcular estáticos
        console.group("Cálculo de campos estáticos");
        Object.keys(valoresEstaticos).forEach(key => {
            const input = document.getElementById(key);
            if (input) {
                const inputValue = parseFloat(input.value) || 0;
                const peso = valoresEstaticos[key];
                const contribucion = (inputValue / 100) * peso;
                sumaEstaticos += contribucion;

                console.log(`${inputValue}% * ${peso} = ${contribucion}`);
            } else {
                console.warn(`Input estático no encontrado: ${key}`);
            }
        });
        console.log(`Suma total de estáticos: ${sumaEstaticos}`);
        console.groupEnd();

        // Calcular dinámicos
        console.group("Cálculo de campos dinámicos");
        const misionesData = JSON.parse('{{ misiones | tojson }}');
        misionesData.forEach(mision => {
            const input = document.getElementById(`${mision.normalized_id}`);
            if (input) {
                const inputValue = parseFloat(input.value) || 0;
                const porcentaje = parseFloat(mision.porcentaje) || 0;
                const contribucion = (2500 * (porcentaje / 100)) * (inputValue / 100);
                sumaDinamicos += contribucion;

                console.log(`(2500 * ${porcentaje}%) * ${inputValue}% = ${contribucion}`);
            } else {
                console.warn(`Input dinámico no encontrado: ${mision.normalized_id}`);
            }
        });
        console.log(`Suma total de dinámicos: ${sumaDinamicos}`);
        console.groupEnd();

        // Calcular resultado total
        const resultadoTotal = sumaEstaticos + sumaDinamicos;
        console.log(`Resultado total: ${sumaEstaticos} + ${sumaDinamicos} = ${resultadoTotal}`);
        console.groupEnd();

        // Actualizar el campo readonly
        const resultadoInput = document.getElementById('resultado-fua');
        const resultadoInputPorcentaje = document.getElementById('resultado-fua-porcentaje');
        if (resultadoInput) {
            resultadoInput.value = resultadoTotal.toFixed(2);
            resultadoInputPorcentaje.value = ( (resultadoTotal /8760)*100).toFixed(2);
        }
    }

    // Agregar evento a los inputs dinámicos
    const inputs = document.querySelectorAll('#section1 input');
    inputs.forEach(input => {
        input.removeEventListener('input', calcularFua);
        input.addEventListener('input', calcularFua);
    });

    // Cálculo inicial
    calcularFua();
}

    </script>

    <script>
        let selectedEquipoId = "{{ equipo_seleccionado.id if equipo_seleccionado else '' }}" || null;

        // Verificar si selectedEquipoId tiene un valor y cargar el equipo correspondiente
        if (selectedEquipoId) {
            cargarEquipo(selectedEquipoId);
        }

    </script>
    

{% endblock %}


